# 开发计划（V1）

本计划基于《设计与开发方案》《前端页面交互与样式设计》，将功能按页面与接口拆分为可实施任务，用作后续开发与验收的统一依据（不含时间排期）。

## 0. 统一约定
- 技术栈：
  - 前端：Vue 3 + Vite + Vue Router + Tailwind（桌面优先，最小适配）
  - 后端：Go 1.21 + internal/httpx（gin 封装）、GORM、go-redis、asynq
- 统一响应：`{ code, message, data, trace_id }`（成功码采用文档默认）。
- 统一计数：NFKC → trim → 连续空白压缩 → 统计非空白字符；后端返回最终 `char_count`，前端实时展示并对账。
- OSS：统一对象存储域（示例 `https://oss.duckai.cn`）。
- 登录：体验版手机号白名单，会话使用 HTTP Only Cookie。

---
## 1. 后端开发计划

### 1.1 配置与基础设施
- 配置项：
  - dlyt.base_url、ASR/TTS（app_id、access_key、resource_id）、DeepSeek（endpoint、api_key）
  - OSS（bucket、domain、ak、sk）、Monitor 白名单 IP
  - 成功码/字段名覆盖（如需将成功码改为 0；响应字段名自定义）
- 初始化顺序（cmd/api/main.go 已具备框架）：
  - config.Init → logx.Init → db.Init → redisx.Init → queue.Init → event.Init → config.InitSvc
  - validators.Init → middleware.Init → router.Init → 监控挂载
- 可观测：访问日志、trace_id、panic recover、`/status` 健康检查

### 1.2 数据库与迁移（参见《设计与开发方案》DDL）
- 建表与索引：
  - `youtube_video`（UK: source_site, video_id）
  - `youtube_transcript`（FK: source_site+video_id；含 utterances、char_count_en/zh）
  - `tts_history`（索引：text_hash；source_site+video_id）
  - `user_whitelist`、`package`、`user_package`、`usage_daily`
- 迁移落地：internal/migration 新增 migrator；字符集/排序统一 `utf8mb4_0900_ai_ci`。

### 1.3 外部服务封装
- dlyt 客户端：
  - Info(ctx, idOrUrl) → { id, title, author, duration_sec, views, publish_date, thumbnail_url }
  - Audio(ctx, idOrUrl) → { audio_url, ext, sample_rate?, channels? }
  - 错误映射：统一到 200xx（含上游 502 → upstream error）
- ASRProvider：Recognize(ctx, audioUrl) → { text_en, duration_ms, utterances[]?, meta }
- Translator：TranslateToZh(ctx, text_en) → { text_zh, meta }
- TTSProvider：Synthesize(ctx, text, speaker, defaults=mp3@24000) → { audio_url, meta }
  - 汇聚分片后上传；错误映射 230xx；必要时缓存幂等结果

### 1.4 领域服务与规则
- TranscriptService：
  - ParseId(source_site='youtube', idOrUrl) → video_id（容错处理：ID/完整 URL）
  - GetOrCreate(ctx, idOrUrl)：
    1) 查 `youtube_transcript` 命中直接返回
    2) 未命中：dlyt.Audio → ASR → Translate → 计算 char_count_en/zh → 入库（含 utterances）
- HistoryService：
  - ListVideos(ctx, page)（`youtube_video` 倒序）
  - GetVideoDetail(ctx, source_site, video_id)（聚合 video + transcript）
  - ListTTS(ctx, page)（`tts_history`）
- TTSService：
  - Synthesize(ctx, text, speaker)：调用 TTSProvider；写入 `tts_history`（text_hash、text_preview、char_count、speaker、audio_url）
  - 记录 `usage_daily` 与 `user_package` 扣减位置预留（V1 可仅展示）
- AccountService：
  - Profile(ctx)（`user_whitelist`）
  - Packages(ctx)（聚合 `user_package` + `package`）
  - Usage(ctx, range=30d)（`usage_daily` 零填充）

### 1.5 控制器与路由（输入/输出）
- POST `/api/yt/info`
  - 入参：{ id_or_url }
  - 出参：dlyt 信息（透传主要字段）
  - 处理：入库 `youtube_video(status=info_only)`
- POST `/api/yt/text`
  - 入参：{ id_or_url }
  - 出参：{
    source_site, video{ id,title,author,duration_sec,publish_date }, thumbnail_url,
    audio{ audio_url, ext, sample_rate?, channels? },
    text_en, text_zh, lang_original, char_count_en, char_count_zh, utterances[], cached
  }
  - 处理：优先命中缓存；否则按流程生成并入库
- POST `/api/tts/synthesize`
  - 入参：{ text, speaker }（音频参数默认 mp3@24000）
  - 出参：{ audio_url, meta{ format,sample_rate }, char_count }
  - 处理：写入 `tts_history`
- 历史：
  - GET `/api/history/videos`（分页）→ list(video 基础信息)
  - GET `/api/history/video/{source_site}/{video_id}` → 聚合详情
  - GET `/api/history/tts`（分页）→ list(tts_history)
- 账号：
  - GET `/api/account/profile` → { phone, display_name }
  - GET `/api/account/packages` → { asr_chars_remain, tts_chars_remain, items:[] }
  - GET `/api/account/usage?range=30d` → { asr_chars_used, tts_chars_used, daily:[] }
- 登录：
  - POST `/api/auth/login_simple`（phone 白名单）
  - POST `/api/auth/logout`

### 1.6 计数/配额与一致性
- 计数：统一工具；ASR 写 `char_count_zh`；TTS 返回 `char_count`；响应值用于前端对账
- 配额（V1 可仅展示）：若启用扣减 → 预扣 user_package → 调用 → 失败回滚/成功确认；写 usage_daily

### 1.7 错误/重试/幂等
- 错误码映射：dlyt→200xx、ASR→210xx、翻译→220xx、TTS→230xx（统一 BizError，HTTP 200）
- 幂等键：Transcript=(source_site, video_id)；TTS=sha256(text+speaker+defaults)
- 重试：外部 5xx 指数退避；失败入 DLQ

### 1.8 测试与样例
- 单元：计数工具、ID 解析、服务 mock
- 集成：yt/info → yt/text → tts/synthesize 闭环；历史/账号接口
- 样例：白名单手机号、演示视频 ID/URL

---
## 2. 前端开发计划

### 2.1 初始化
- 依赖安装、Tailwind 引入；基础导航与布局
- 路由：`/`（首页）、`/video`、`/edit`、`/history`、`/history/tts`、`/account`

### 2.2 页面实现（按用户流程）
- 首页 Home：
  - `YtLinkInput`：校验 URL/ID → `/api/yt/info` → 跳转 `/video?vid=...`
  - 文本/文件模式：选择 txt/md → 前端解析 → 跳转 `/edit` 并填充中文编辑框
- 视频信息页 Video：
  - `VideoCard` 展示；“获取文本与音频”→ `/api/yt/text` → 跳转 `/edit`
- 编辑与生成页 Edit：
  - 左：英文只读；右：中文可编辑；`CharCounter` 实时计数
  - `VoiceSelector`、`GenerateButton` → `/api/tts/synthesize` → `AudioPlayer`
  - 来源兼容：YouTube 或文件模式
- 历史页 History/HistoryTTS/VideoDetail：
  - 视频历史列表 → 详情（中英/分句/音频直链）
  - 合成历史列表 → 文本预览/字符数/音色/时间；支持播放/复制
- 账号页 Account：
  - 套餐卡片（ASR/TTS 剩余量/总量/有效期）
  - 使用统计（近 30 天折线/表格）
- 登录/退出（Header 菜单）：
  - 未登录：手机号登录弹窗 → `/api/auth/login_simple`
  - 已登录：显示 `display_name`；退出 → `/api/auth/logout`

### 2.3 API 与工具
- api/yt.ts：`info(idOrUrl)`、`text(idOrUrl)`
- api/tts.ts：`synthesize({ text, speaker })`
- api/history.ts：`listVideos(p)`、`getVideo(site,id)`、`listTTS(p)`
- api/account.ts：`profile()`、`packages()`、`usage(range)`、`login(phone)`、`logout()`
- http 封装：携带 Cookie；统一错误 toast；loading 标识
- utils/text.ts：`normalizeAndCount`（统一计数）
- utils/file.ts：txt/md 解析（剔除 markdown 语法，保留段落换行）

### 2.4 状态管理（可选 Pinia）
- userStore：profile
- accountStore：packages、usage
- videoStore：currentVideo、currentTranscript
- ttsStore：lastResult

### 2.5 样式与组件规范
- 按《前端页面交互与样式设计》；不提供音频参数选择（默认后端处理）
- 桌面优先；最小栅格适配；基础 ARIA 标签

### 2.6 自测与联调用例
- URL → 信息页 → 文本页（含 utterances/char_count_zh）
- 生成音频成功并可播放/下载
- 上传 txt/md 解析正确并可合成
- 历史列表与详情、合成历史列表展示正确
- 账号页显示剩余量与统计；登录/退出流程通畅

---
## 3. 联调顺序与验收

### 3.1 联调顺序
1) `/api/yt/info` → 视频信息页
2) `/api/yt/text` → 编辑页数据
3) `/api/tts/synthesize` → 生成与播放
4) `/api/history/*` → 历史功能
5) `/api/account/*` 与 `/api/auth/*` → 套餐/使用/登录退出

### 3.2 验收标准
- 闭环：YouTube 链接 → 文本（中英/分句/字数）→ 合成音频
- 文本/文件模式：txt/md 解析准确且可合成
- 历史：视频/合成历史可查询与查看，详情准确
- 套餐与使用：剩余量/总量/有效期展示；近 30 天用量统计正常
- 登录/退出：白名单登录成功；退出后受保护信息不显示
- 计数一致：前后端字符计数一致；以服务端为准
- 错误提示：dlyt/ASR/TTS 失败给出明确提示与重试建议

### 3.3 交付物
- 前端与后端可运行代码
- 数据库迁移脚本与初始化样例
- `.env` 示例（去敏）
- Postman/HTTPie 集合或 cURL 示例
- 测试账号（白名单手机号）与演示视频 ID

---
## 4. 风险与应对
- dlyt Cookie 有效性：监控错误码，及时更新 cookies；失败兜底提示
- TTS WebSocket 稳定性：超时/重试，失败落盘日志与 DLQ
- 计数差异：统一工具与单测覆盖；前端展示“以服务端为准”
- 配额扣减一致性：V1 展示优先；若启扣减，采用预扣→回滚/确认并写 usage_daily
