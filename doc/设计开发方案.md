# 设计与开发方案（初稿）

本文档基于现有仓库与 `doc/` 资料（功能需求、ASR/TTS、YouTube 下载服务等）形成的设计初稿，用于评审与迭代。后续仅在本文件迭代，不改动原文档。

## 1. 目标与范围

- 目标：输入 YouTube 链接或用户文本，生成“使用用户自定义音色/复刻音色”的朗读音频；支持可视化编辑、字符计费与配额限制；具备可扩展、可观测与容错能力。
- 范围：前端（Vue 3+Vite+Tailwind）、后端（Go + gin 封装）、下载服务（已存在 dlyt 服务）、对象存储（七牛/自有 OSS）、外部服务（火山 ASR/大模型 TTS、DeepSeek 翻译）。

## 2. 用户场景与业务流程

### 2.1 场景 A：YouTube 链接生成音频
1) 用户输入链接 → 后端调用下载服务获取视频信息与缩略图（必要时仅信息，不触发下载）
2) 用户确认 → 触发“仅音频上传”获取音频直链（存储到 OSS）
3) 后端调用 ASR（录音文件极速识别），得到转写文本（语言不强制，仅保存结果）
4) 后端调用 LLM（DeepSeek）将文本转为中文，应用统一提示词风格（可配置）
5) 前端展示“原文+中文”，允许用户编辑中文文本，并提示字符数
6) 用户选择音色与参数 → 触发 TTS（大模型单向流式 v3，支持复刻 2.0 与混音）
7) 生成音频文件，上传 OSS，返回播放直链，沉淀为可下载/再次分享的资源

### 2.2 场景 B：用户文本/文件生成音频
1) 用户输入文本或上传 txt/md → 前端解析/预处理（见“字符计费规范”）并统计字符数
2) 用户选择音色与参数 → 提交 TTS 生成音频 → 上传 OSS → 返回直链

备注：两条链路的“文本→TTS”阶段完全复用。

## 3. 系统架构与组件

- 前端（`vue-web`）：路由式单页，Tailwind 原子化样式；核心页面：链接解析/信息确认、文本编辑与参数选择、生成与结果页。
- 核心后端（`go-gin`）：
  - API 层：统一 `httpx` 处理、统一响应格式与 traceId；
  - 业务模块：YouTube 代理（调用 dlyt）、ASR、翻译、TTS、计费与配额、资源管理；
  - 基础设施：日志（zerolog）、DB（gorm+MySQL）、Redis、队列（asynq）、定时任务、事件总线、监控；
- 下载服务（`dlyt`）：提供 `/api/yt/info`、`/api/yt/audio`，上传到对象存储并返回直链；
- 外部服务：
  - ASR：`POST https://openspeech.bytedance.com/api/v3/auc/bigmodel/recognize/flash`
  - TTS：`wss://openspeech.bytedance.com/api/v3/tts/unidirectional/stream`
  - 翻译：DeepSeek（可替换/并行厂商，需抽象层）
- 对象存储：七牛/自有 OSS（示例域 `https://oss.duckai.cn`）。

## 4. 模块设计

### 4.1 前端（Vue 3 + Vite + Tailwind）
- 页面结构：
  - 首页：模式选择（链接/文本）、最近任务列表
  - 链接解析页：输入链接 → 展示视频信息/缩略图 → 确认继续
  - 编辑页：原文/中文并排或切换，字符统计、音色参数选择（采样率/格式/语速/情感等）、费用预估
  - 结果页：播放控件、下载链接、分享/复制链接
- 统一字符计数展示（与后端一致，见第 7 章）
- 进度与状态提示：分阶段（解析/下载/转写/翻译/合成/上传）
- 待选：Pinia 管理跨页状态（文本、视频信息、TTS 选项、计数与费用）

### 4.2 后端 API（收敛版）

- `POST /api/yt/info`：入参 `{ id_or_url }`；转发 dlyt `/api/yt/info` 并将基础信息落库至 `youtube_video`（status=info_only）。
- `POST /api/yt/text`：入参 `{ id_or_url }`；命中缓存则直接返回；否则调用 dlyt `/api/yt/audio` → ASR → 翻译，落库 `youtube_video` 与 `youtube_transcript`，返回聚合结果（中文译文、英文原文、音频直链）。

接口返回统一 `{ code, message, data, trace_id }`；错误语义对齐 `BizError/ServerError`。

#### 历史记录接口（补充，非核心两主流程）

- `GET /api/history/videos?source_site=youtube&page=1&page_size=20`
  - 返回已处理的视频列表（基于 `youtube_video`，按 `processed_at` 或 `updated_at` 倒序）
  - data.list 字段包含：`source_site, video_id, title, author, duration_sec, thumbnail_url, processed_at`

- `GET /api/history/tts?page=1&page_size=20`
  - 返回已生成的合成记录列表（基于 `tts_history`）
  - data.list 字段包含：`id, source_site?, video_id?, text_preview, char_count, speaker, audio_url, created_at`

- `GET /api/history/video/{source_site}/{video_id}`（可选）
  - 返回单个视频详情（聚合 `youtube_video` 与 `youtube_transcript`）

#### 套餐与配额接口（新增）

- `GET /api/account/profile`
  - 返回当前用户：`{ phone, display_name }`
- `GET /api/account/packages`
  - 返回套餐与剩余量：`{ asr_chars_remain, tts_chars_remain, items: [{ id, name, asr_chars_total, tts_chars_total, expire_at, status }] }`
- `GET /api/account/usage?range=30d`
  - 返回用量统计：`{ asr_chars_used, tts_chars_used, daily: [{ date, asr_chars, tts_chars }] }`

#### 登录与退出接口（体验版）

- `POST /api/auth/login_simple`
  - 入参：`{ phone }`（与白名单匹配）
  - 成功：设置 HTTP Only Cookie（会话 Token），返回 `{ user }`
- `POST /api/auth/logout`
  - 清除会话 Cookie，返回成功

### 4.3 业务服务与抽象
- VideoFetcher：`FetchInfo(idOrUrl)`, `FetchAudio(idOrUrl)`（对接 `dlyt`）
- ASRProvider：`Recognize(audioUrl)`（火山极速识别）
- Translator：`Translate(text, target)`（DeepSeek，提示词模板可配置）
- TTSProvider：`Synthesize(text, opts) -> audioUrl`（对接火山单向流式，服务端汇聚分片并上传）
- Storage：`PutObject`, `SignURL`（统一对象存储抽象）
- Billing：`PreviewCharge(chars, type)`, `Consume(user, amount, type)`（两类配额：ASR 与 TTS 分开计量）
- Counter：统一字符计数实现（见第 7 章），前后端共用规则

### 4.4 任务编排与异步化
- 使用 asynq 定义任务：
  - `ExtractAudioTask` → `AsrTask` → `TranslateTask` → `TtsTask` → `UploadTask`
  - 支持“单步直调”与“一键流水线”两种模式
- 重试策略：指数退避+上限；对外部服务区分可重试/不可重试错误；失败归档到 DLQ
- 幂等：以资源键（`audio_url`+参数哈希）去重，避免重复计费
- 状态事件：通过 eventbus 发进度事件，前端可轮询 `GET /jobs/{id}` 或订阅（后期可加 SSE）

## 5. 数据模型（简化草案）

- User：`id, phone, status, created_at`
- QuotaAccount：`user_id, asr_chars_balance, tts_chars_balance, updated_at`
- MediaAsset：`id, type[thumbnail|audio|tts], url, meta(json), owner_id`
- Transcript：`id, source_audio_url, lang, text_raw, text_cn, duration_ms, owner_id`
- SynthesisRequest：`id, user_id, text, params(json), char_count, status, created_at`
- SynthesisResult：`id, request_id, audio_url, meta(json)`
- TTSHistory：`id, source_site, video_id, text_hash, text_preview, char_count, speaker, audio_url, meta(json), created_at`
- UserWhitelist：`id, phone, display_name?, status, created_at`
- Package：`id, name, asr_chars_total, tts_chars_total, expire_at, status`
- UserPackage：`id, user_id, package_id, asr_chars_remain, tts_chars_remain, expire_at, status, created_at`
- UsageDaily：`id, user_id, date, asr_chars, tts_chars`
- Job：`id, type, payload(json), status, error, progress(json), created_at, finished_at`

说明：后续可补充订单/交易模型；当前以配额账户为主。

## 6. 配置与密钥

- 后端 `.env`/`config.yaml`：
  - 火山 ASR/TTS：`app_id, access_key, resource_id`（ASR `volc.bigasr.auc_turbo`；TTS 见文档）
  - DeepSeek：`api_key`, `endpoint`
  - OSS：`bucket, access_key, secret, domain`
  - dlyt 服务：`base_url`（示例 `http://43.133.180.227:9005`）
  - 限流与并发：每用户并发上限、全局并发阈值

## 7. 统一字符计费规范（前后端一致）

- 计费口径：
  - ASR：按“中文译文字符数”计费（便于与 TTS 统一语种口径）；
  - TTS：按“最终提交合成的文本字符数”计费；
- 计数规则：
  - 预处理：NFKC 归一化；去掉首尾空白；将连续空白压缩为单个空格；
  - 统计对象：保留所有可见字符（字母、数字、标点、符号），不统计空白字符（空格、换行、制表符）；
  - 公式：`char_count = count(codepoint for c in normalized_text if !is_whitespace(c))`
- 前端与后端统一实现（同一正则/库），并在响应中返回后端判定的最终计数用于对账。

## 8. 可扩展性设计

- 抽象提供者接口（VideoFetcher/ASRProvider/Translator/TTSProvider/Storage），便于接入 bilibili/不同云厂商；
- 参数可扩展：TTS `audio_params`（format, sample_rate, bit_rate, emotion, speech_rate, loudness 等）、`additions`（silence_duration、cache_config、post_process 等）原样透传；
- 任务并行：同一文本可并行多音色（不同请求 id），或串行汇聚；
- 插件化 Prompt：翻译提示词模板化，支持多风格、行业术语库。

## 9. 稳定性与可靠性

- 超时与重试：对外部服务统一超时（ASR/TTS/翻译/下载）；区分 4xx/5xx；
- 熔断与限流：按用户、按全局、按服务维度；
- 队列与 DLQ：失败持久化，人工/自动补偿；
- 幂等与去重：参数哈希+资源键，避免重复扣费与重复生成；
- 大文件处理：ASR 建议传 `audio.url`；TTS 服务端聚合分片为单一文件再上传；
- 观测：结构化日志、trace_id 贯穿、访问日志与队列监控（asynqmon）；健康检查 `/status`。

## 10. 安全

- 密钥仅存后端；前端绝不暴露云厂商凭据；
- 监控面板（/monitor）走白名单；
- 体验版登录：手机号白名单；后续加入完整 OAuth/短信登录；
- 生成内容合规：预留敏感词/风险提示开关（后续扩展）。

## 11. 成本与计费策略

- 费用预估：前端调用 `/api/quota/charge_preview` 基于后端计数规则回传；
- 扣费点：ASR 完成后扣 ASR 配额；TTS 提交前预扣，成功后实扣、失败回滚；
- 透出：结果页展示计量与本次消耗；配额不足时阻断后续阶段。

## 12. 风险与开放问题

- YouTube 下载在年龄/地区限制下依赖 cookies（需监控有效期，否则上游 502）；
- TTS WebSocket 长连接稳定性、网络抖动与断点续传策略；
- DeepSeek 翻译风格一致性与可配置化；
- 跨语种标点/空白处理对字符计费的影响（需一致化单测）；
- OSS 存储与带宽成本，是否需要过期清理与归档策略。

## 13. 里程碑（建议）

- M1 可用版本：
  - A 链路打通（YouTube→音频→ASR→翻译→TTS→音频直链）
  - 统一字符计数前后端对齐，基础配额控制
  - 观测/健康/监控面板
- M2 体验优化：
  - 页面完善（编辑器、音色筛选、参数预设）、多音色并发合成
  - 任务队列/失败重试/进度可视化
- M3 扩展：
  - 支持 bilibili 等站点；多厂商 ASR/TTS/翻译可切换
  - 订单与充值闭环、账号体系完善

## 附录 A：错误码约定（示例）

- 10000 通用错误；10001 参数校验失败；
- 200xx 下载服务错误；210xx ASR 错误；220xx 翻译错误；230xx TTS 错误；
- 300xx 配额不足/扣费失败；
- 4xx/5xx 映射为 `ServerError`。

## 接口收敛（YouTube 场景，仅两条）

- 1) 获取视频信息（转发 dlyt）
```
POST /api/yt/info { id_or_url }
=> 直接转发 dlyt `/api/yt/info` 成功返回：
   { id, title, author, duration_sec, views, publish_date, thumbnail_url }
缓存策略：
- 后端可将基础信息以 `video_id` 为键写入 `youtube_video`（不含音频/文本），status=info_only
```

- 2) 获取视频的文字信息（一次性返回中文/英文/音频/分句）
```
POST /api/yt/text { id_or_url }
服务端流程：
1) 解析 video_id，查询 DB：如 `youtube_transcript` 已存在，直接返回缓存结果
2) 如无缓存：调用 dlyt `/api/yt/audio` 拿到音频直链 → 调用 ASR（极速识别）获得英文 → 调用翻译（DeepSeek）转中文
3) 将视频基础信息/缩略图/音频直链/英文文本/中文文本/分句写入 DB；返回聚合结果

响应示例：
{
  "source_site": "youtube",
  "video": { "id": "jNQXAC9IVRw", "title": "...", "author": "...", "duration_sec": 123, "publish_date": "2024-01-01" },
  "thumbnail_url": "https://oss.duckai.cn/thumbs/jNQXAC9IVRw_1280x720.jpg",
  "audio": { "audio_url": "https://oss.duckai.cn/audio/jNQXAC9IVRw.m4a", "ext": "m4a", "sample_rate": 48000, "channels": 2 },
  "text_en": "...",
  "text_zh": "...",
  "lang_original": "en",
  "char_count_en": 1234,
  "char_count_zh": 1200,
  "utterances": [
    { "start_time": 450, "end_time": 1530, "text": "..." }
  ],
  "cached": true|false
}
```

说明：以上两条接口即可完成 YouTube 场景；后续 TTS 由前端携带文本调用 `/api/tts/synthesize` 单独完成。

## TTS 合成接口（最小闭环）

- `POST /api/tts/synthesize`
  - 入参：
    ```
    {
      "text": "用户编辑后的中文文本",
      "speaker": "音色ID",
      "audio_params": { "format": "mp3", "sample_rate": 24000 },
      "additions": { } // 可选：按 TTS 文档透传（emotion、speech_rate 等）
    }
    ```
  - 行为：
    - 服务端按“统一字符计费规范”进行字符计数（与前端算法一致），计算 `char_count` 用于计费与对账。
    - 调用 TTS（单向流式 v3），汇聚生成音频并上传对象存储，返回直链。
    - 幂等：以 `{text,speaker,audio_params,additions}` 的参数哈希为键做去重缓存，避免重复扣费。
  - 出参：
    ```
    {
      "audio_url": "https://oss.duckai.cn/tts/xxx.mp3",
      "meta": { "format": "mp3", "sample_rate": 24000 },
      "char_count": 1200
    }
    ```

## TTS 合成接口（最小闭环）

- `POST /api/tts/synthesize`
  - 入参：
    ```
    {
      "text": "用户编辑后的中文文本",
      "speaker": "音色ID",
      "audio_params": { "format": "mp3", "sample_rate": 24000 },
      "additions": { }
    }
    ```
  - 行为：
    - 服务端按统一字符计数算法计算 `char_count`（与第 7 章一致），用于计费与响应。
    - 调用 TTS（单向流式 v3），聚合生成音频并上传到对象存储，返回直链。
  - 出参：
    ```
    {
      "audio_url": "https://oss.duckai.cn/tts/xxx.mp3",
      "meta": { "format": "mp3", "sample_rate": 24000 },
      "char_count": 1200
    }
    ```

## 数据库设计（定稿）

### 关系与缓存策略
- `youtube_video`：按 `(source_site, video_id)` 唯一存一条基础元信息与资源链接（缩略图、音频），避免重复下载/上传。
- `youtube_transcript`：与 `youtube_video` 一对一（或一对零/一），存英文转写、中文译文、分句、计数与元数据。
- 复用策略：请求 `/api/yt/text` 时优先命中 `youtube_transcript`；若不存在则按流程生成并入库。

### MySQL 8 DDL（建议）
```sql
CREATE TABLE IF NOT EXISTS youtube_video (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  source_site VARCHAR(32) NOT NULL DEFAULT 'youtube' COMMENT '来源站点: youtube/bilibili/...',
  video_id VARCHAR(32) NOT NULL COMMENT 'YouTube 11位ID或标准化ID',
  source_url VARCHAR(1024) NULL COMMENT '原始链接（可选）',
  title VARCHAR(512) NULL,
  author VARCHAR(256) NULL,
  duration_sec INT NULL,
  views BIGINT NULL,
  publish_date DATE NULL,
  thumbnail_url VARCHAR(1024) NULL,
  audio_url VARCHAR(1024) NULL,
  audio_ext VARCHAR(16) NULL,
  audio_bitrate_kbps INT NULL,
  audio_sample_rate INT NULL,
  audio_channels TINYINT NULL,
  storage_provider VARCHAR(32) DEFAULT 'qiniu' COMMENT '对象存储提供方',
  storage_path VARCHAR(512) NULL COMMENT '对象存储路径（可选）',
  status TINYINT NOT NULL DEFAULT 0 COMMENT '0:init 1:info_only 2:ready 3:failed',
  processed_at DATETIME NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_site_video (source_site, video_id),
  KEY idx_status (status),
  KEY idx_updated_at (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS youtube_transcript (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  source_site VARCHAR(32) NOT NULL DEFAULT 'youtube' COMMENT '来源站点: youtube/bilibili/...',
  video_id VARCHAR(32) NOT NULL COMMENT '外键：youtube_video.video_id',
  lang_original VARCHAR(8) NOT NULL DEFAULT 'en',
  text_original LONGTEXT NULL,
  text_zh LONGTEXT NULL,
  utterances JSON NULL COMMENT 'ASR 分句结果',
  duration_ms INT NULL,
  char_count_en INT NULL,
  char_count_zh INT NULL,
  asr_meta JSON NULL,
  translate_meta JSON NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_site_video (source_site, video_id),
  CONSTRAINT fk_transcript_site_video FOREIGN KEY (source_site, video_id)
    REFERENCES youtube_video (source_site, video_id)
    ON UPDATE CASCADE ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 合成历史（TTS）
CREATE TABLE IF NOT EXISTS tts_history (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  source_site VARCHAR(32) NULL COMMENT '来源站点: youtube/bilibili/...（文本模式可为空）',
  video_id VARCHAR(32) NULL COMMENT '若来自视频场景可填对应 video_id',
  text_hash CHAR(64) NOT NULL COMMENT '输入文本的 SHA256，用于幂等与检索',
  text_preview VARCHAR(256) NOT NULL COMMENT '前若干字符预览，便于列表展示',
  char_count INT NOT NULL,
  speaker VARCHAR(128) NOT NULL,
  audio_url VARCHAR(1024) NOT NULL,
  meta JSON NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_created_at (created_at),
  KEY idx_text_hash (text_hash),
  KEY idx_video (source_site, video_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 可选：全文索引便于检索（MySQL 8 InnoDB 支持）
-- ALTER TABLE youtube_transcript ADD FULLTEXT ft_text_zh (text_zh);
-- ALTER TABLE youtube_transcript ADD FULLTEXT ft_text_en (text_original);
```

```sql
-- 合成历史（TTS）
CREATE TABLE IF NOT EXISTS tts_history (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  source_site VARCHAR(32) NULL COMMENT '来源站点: youtube/bilibili/...（文本模式可为空）',
  video_id VARCHAR(32) NULL COMMENT '若来自视频场景可填对应 video_id',
  text_hash CHAR(64) NOT NULL COMMENT '输入文本的 SHA256，用于幂等与检索',
  text_preview VARCHAR(256) NOT NULL COMMENT '前若干字符预览，便于列表展示',
  char_count INT NOT NULL,
  speaker VARCHAR(128) NOT NULL,
  audio_url VARCHAR(1024) NOT NULL,
  meta JSON NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_created_at (created_at),
  KEY idx_text_hash (text_hash),
  KEY idx_video (source_site, video_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 账号白名单（体验版登录）
CREATE TABLE IF NOT EXISTS user_whitelist (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  phone VARCHAR(32) NOT NULL,
  display_name VARCHAR(64) NULL,
  status TINYINT NOT NULL DEFAULT 1,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  UNIQUE KEY uk_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 套餐与绑定
CREATE TABLE IF NOT EXISTS package (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  name VARCHAR(64) NOT NULL,
  asr_chars_total INT NOT NULL,
  tts_chars_total INT NOT NULL,
  expire_at DATETIME NULL,
  status TINYINT NOT NULL DEFAULT 1,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

CREATE TABLE IF NOT EXISTS user_package (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  package_id BIGINT UNSIGNED NOT NULL,
  asr_chars_remain INT NOT NULL,
  tts_chars_remain INT NOT NULL,
  expire_at DATETIME NULL,
  status TINYINT NOT NULL DEFAULT 1,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY idx_user (user_id),
  CONSTRAINT fk_user_package_package FOREIGN KEY (package_id) REFERENCES package (id)
    ON UPDATE CASCADE ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;

-- 每日用量聚合（便于趋势展示）
CREATE TABLE IF NOT EXISTS usage_daily (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  date DATE NOT NULL,
  asr_chars INT NOT NULL DEFAULT 0,
  tts_chars INT NOT NULL DEFAULT 0,
  PRIMARY KEY (id),
  UNIQUE KEY uk_user_date (user_id, date),
  KEY idx_date (date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```

### 读写要点
- `youtube_video.status`：
  - info_only：已保存基本信息与缩略图；
  - ready：已具备音频与文本（对应 transcript 存在）。
- 幂等：以 `(source_site, video_id)` 作为唯一键；生成阶段失败可重试，成功后更新时间戳。
- 计费：`char_count_zh/char_count_en` 采用统一字符计数规则（第 7 章）。

### 历史记录与列表读取
- 视频历史：直接基于 `youtube_video`（按 `processed_at`/`updated_at` 倒序），必要时与 `youtube_transcript` 关联以取 `char_count_zh`。
- 合成历史：基于 `tts_history`。写入时记录 `text_hash/text_preview/char_count/speaker/audio_url`。


