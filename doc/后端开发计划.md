# 后端开发计划（V1）

本计划基于当前 `go-gin/` 代码与《设计与开发方案》《开发计划》对照梳理，明确需要新增/修改的点，并列出实施清单。

## 0. 现状对比（delta）
- 已有：
  - 入口 `cmd/api/main.go`、日志/DB/Redis/队列初始化、HTTP 封装（internal/httpx）、路由框架、事件/任务/迁移骨架
- 缺失：
  - 业务控制器与服务：`/api/yt/info`、`/api/yt/text`、`/api/tts/synthesize`、历史/账号/登录接口
  - 外部服务封装：dlyt、ASR、翻译（DeepSeek）、TTS
  - 数据表：`youtube_video`、`youtube_transcript`、`tts_history`、`user_whitelist`、`package`、`user_package`、`usage_daily`

## 1. 数据库与迁移
- 新增 DDL（参考设计文档），添加到 `migration/ddl/*`，实现 `migration/manager.go` 注册与执行
- 验证外键与唯一键；为常用查询加索引

## 2. 外部服务封装（internal/httpc 或 rest/*）
- dlyt：
  - `Info(ctx, idOrUrl)` 调用 POST /api/yt/info（dlyt 服务）
  - `Audio(ctx, idOrUrl)` 调用 POST /api/yt/audio（dlyt 服务）
  - 错误统一到 200xx，保留上游 message
- ASR：`Recognize(ctx, audioUrl)` 调用火山 flash API（url 模式）
- 翻译：`TranslateToZh(ctx, text)` 调用 DeepSeek；提示词模板化
- TTS：`Synthesize(ctx, text, speaker, defaults)` 调用单向流式 v3；汇聚分片并上传 OSS

## 3. 领域服务（internal/*/svc 或 logic/）
- TranscriptService：
  - `ParseId(source_site, idOrUrl)` → 解析 video_id
  - `GetOrCreate(ctx, idOrUrl)` → 命中 transcript 返回；否则 dlyt.Audio → ASR → 翻译 → 计数 → 入库
- HistoryService：`ListVideos`、`GetVideoDetail`、`ListTTS`
- TTSService：`Synthesize` → TTS → 写入 `tts_history`（text_hash、text_preview、char_count、speaker、audio_url）
- AccountService：`Profile`（白名单）、`Packages`（聚合剩余量）、`Usage`（近 30 天）

## 4. 控制器与路由（router/* + controller/*）
- 新增控制器：`controller/yt_controller.go`、`controller/tts_controller.go`、`controller/history_controller.go`、`controller/account_controller.go`、`controller/auth_controller.go`
- 路由注册：`router/` 下新增 `yt.go`、`history.go`、`account.go`、`auth.go`
  - POST `/api/yt/info`
  - POST `/api/yt/text`
  - POST `/api/tts/synthesize`
  - GET `/api/history/videos`、GET `/api/history/video/{source_site}/{video_id}`、GET `/api/history/tts`
  - GET `/api/account/profile`、GET `/api/account/packages`、GET `/api/account/usage`
  - POST `/api/auth/login_simple`、POST `/api/auth/logout`

## 5. 统一计数与配额
- `internal/util` 下新增计数工具，ASR 与 TTS 调用前/后使用；TTS 返回写入响应
- 配额（V1 可仅展示）：预留扣减函数；`usage_daily` 写入位置预留

## 6. 错误/幂等/重试
- 错误映射：dlyt→200xx、ASR→210xx、翻译→220xx、TTS→230xx；统一 `httpx.Error`
- 幂等键：Transcript=(source_site, video_id)；TTS=sha256(text+speaker+defaults)
- 重试：对 5xx 指数退避；失败入 DLQ

## 7. 测试与联调
- 单元：计数工具、ID 解析、服务 mock
- 集成：/api/yt/info → /api/yt/text → /api/tts/synthesize 闭环
- 历史与账号接口返回正确；登录白名单可用

## 8. 交付物
- 控制器/服务/客户端代码与注释
- 迁移脚本与 README 片段（.env 示例）
- Postman/HTTPie 示例
