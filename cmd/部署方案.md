## 目标

- 持续导出 Edge 登录态 Cookie 到 Redis，供后端使用。
- 降低维护成本，避免并发/挂起。

## 方案 A：Edge 常驻 + 计划任务仅跑 Python（简单）

- 思路：Edge 始终以 `--remote-debugging-port=9222` 运行；计划任务每 5 分钟执行 Python 刷新 Redis 中的 Cookie。

- 一次性配置 Edge 常驻（两选一）：
  - 启动文件夹：Win+R → `shell:startup`，创建 `msedge.exe` 快捷方式，目标示例：
```cmd
"C:\\Program Files (x86)\\Microsoft\\Edge\\Application\\msedge.exe" --remote-debugging-port=9222 --user-data-dir=%LOCALAPPDATA%\\EdgeCookieExport
```
  - 或在“任务计划程序”创建一个“登录时”触发的任务，命令同上（建议任务名：`EdgeDebug9222`）。

- 配置计划任务（每 5 分钟，仅执行 Python）：
  - 触发器：按计划，每 5 分钟重复，持续无限期
  - 操作：启动程序
  - 程序/脚本：`python`
  - 添加参数：`D:\File\text-voice\cmd\export_edge_cookie.py youtube`（或 `bilibili`）
  - 起始于：`D:\File\text-voice\`
  - 设置：勾选“允许按需运行任务”；选择“若任务已在运行，则不启动新实例”
  - 条件：可取消“仅当计算机使用交流电源时才启动”
  - 账户：选择当前登录账号，并勾“仅当用户登录时运行”（避免桌面会话/配置目录权限问题）

- 注意：首次在该专用目录的 Edge 窗口登录一次对应平台，使 Cookie 持久化。

## 方案 B：一键脚本（自检端口→按需启动 Edge→再导出）（推荐）

- 思路：创建一个 PowerShell 脚本（例如 `D:\File\text-voice\cmd\export-cookies.ps1`），先检查 9222 端口是否有 Edge 调试；若无则启动带调试端口的 Edge，然后执行 Python 导出。计划任务每 5 分钟只调用该脚本。

- 创建脚本 `export-cookies.ps1`：
```powershell
param(
  [Parameter(Mandatory = $true)]
  [ValidateSet('youtube','bilibili')]
  [string]$Platform
)

$port = 9222
$edgeArgs = "--remote-debugging-port=$port --user-data-dir=$env:LOCALAPPDATA\\EdgeCookieExport"

# 端口是否已被 Edge 调试占用
$listening = Get-NetTCPConnection -State Listen -LocalPort $port -ErrorAction SilentlyContinue
if (-not $listening) {
  $edgePath = "$env:ProgramFiles(x86)\Microsoft\Edge\Application\msedge.exe"
  if (-not (Test-Path $edgePath)) { $edgePath = "$env:ProgramFiles\Microsoft\Edge\Application\msedge.exe" }
  Start-Process -FilePath $edgePath -ArgumentList $edgeArgs | Out-Null
  Start-Sleep -Seconds 2
}

# 执行 Python 导出
$python = "python"
$script = "D:\\File\\text-voice\\cmd\\export_edge_cookie.py"
& $python $script $Platform
```

- 配置计划任务（每 5 分钟）：
  - 程序/脚本：`powershell.exe`
  - 添加参数：`-NoProfile -ExecutionPolicy Bypass -File D:\File\text-voice\cmd\export-cookies.ps1 -Platform youtube`
  - 起始于：`D:\File\text-voice\cmd\`
  - 其他设置同方案 A（不启动新实例；仅当用户登录时运行）。B 站再建一个把 `-Platform bilibili` 的任务。

- 注意：无需手工 taskkill 或预先启动 Edge；脚本会自动“有则用、无则启”。第一次同样需在专用目录 Edge 窗口登录一次。

### 可选：脚本自循环定时（登录时启动一次，脚本内部每 N 分钟执行）

- 用法：让计划任务“登录时”启动一次脚本，脚本内部以循环方式每 N 分钟执行一次导出，避免创建高频触发的计划任务。
- 命令（示例，每 5 分钟）：
```powershell
powershell.exe -NoProfile -ExecutionPolicy Bypass -File D:\File\text-voice\cmd\export-cookies.ps1 -Platform youtube -Loop -IntervalMinutes 5
```
- 说明：
  - `-Loop`：开启自循环；`-IntervalMinutes`：循环间隔，默认 5 分钟
  - 已内置互斥锁，避免重复实例；仍建议在计划任务勾选“若任务已在运行，则不启动新实例”
  - 如需同时跑多个平台，请分别创建任务（各自指定 `-Platform`）

## 通用建议

- Python 路径：若系统 `python` 未在 PATH，可改用完整路径（如 `C:\\Python312\\python.exe`），或使用 `py -3`。
- 重叠保护：在任务“设置”中选择“如果任务已在运行，则不启动新实例”，避免并发冲突。
- 运行超时：可在“设置”中启用“运行超过 2 分钟则停止任务”，防止挂起。
- 频率：5 分钟通常足够；如平台过期策略更严格，可调为 10–15 分钟以减少无谓刷新。